<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="css/common.css">
  <title>AR Session</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    #ar-view {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    #menu {
      position: absolute;
      top: 10px;
      left: 10px;
      background-color: white;
      border: 2px solid black;
      padding: 5px;
      z-index: 1;
    }
    select {
      font-size: 16px;
    }
    #start-ar-button {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 15px 30px;
      font-size: 18px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      z-index: 2;
    }
  </style>
</head>
<body>
  <header>
    <div id="menu">
      <label for="room-select">Select Room:</label>
      <select id="room-select">
        <option value="">-- Select Rooms --</option>
        <!-- Room options will be added here -->
      </select>
    </div>
  </header>
  <div id="ar-view"></div>
  <button id="start-ar-button">Start AR</button>
  
  <script type="module">
    import { WebXRButton } from './js/util/webxr-button.js';
    import { Scene } from './js/render/scenes/scene.js';
    import { Renderer, createWebGLContext } from './js/render/core/renderer.js';
    import { InlineViewerHelper } from './js/util/inline-viewer-helper.js';
    import WebXRPolyfill from './js/third-party/webxr-polyfill/build/webxr-polyfill.module.js';

    let xrButton = null;
    let xrImmersiveRefSpace = null;
    let inlineViewerHelper = null;
    let gl = null;
    let renderer = null;
    let scene = new Scene();

    function initXR() {
      xrButton = new WebXRButton({
        onRequestSession: onRequestSession,
        onEndSession: onEndSession,
        textEnterXRTitle: "START AR",
        textXRNotFoundTitle: "AR NOT FOUND",
        textExitXRTitle: "EXIT AR",
      });

      // Hide XR button and use custom button instead
      xrButton.domElement.style.display = 'none';
      document.querySelector('#start-ar-button').addEventListener('click', () => {
        if (navigator.xr) {
          navigator.xr.requestSession('immersive-ar').then(onSessionStarted);
        }
      });

      document.querySelector('header').appendChild(xrButton.domElement);
    }

    function onRequestSession() {
      return navigator.xr.requestSession('immersive-ar')
        .then((session) => {
          xrButton.setSession(session);
          session.isImmersive = true;
          onSessionStarted(session);
        });
    }

    function initGL() {
      if (gl) return;
      gl = createWebGLContext({ xrCompatible: true });
      document.getElementById('ar-view').appendChild(gl.canvas);
      function onResize() {
        gl.canvas.width = gl.canvas.clientWidth * window.devicePixelRatio;
        gl.canvas.height = gl.canvas.clientHeight * window.devicePixelRatio;
      }
      window.addEventListener('resize', onResize);
      onResize();
      renderer = new Renderer(gl);
      scene.setRenderer(renderer);
    }

    function onSessionStarted(session) {
      session.addEventListener('end', onSessionEnded);
      initGL();
      session.updateRenderState({ baseLayer: new XRWebGLLayer(session, gl) });
      let refSpaceType = session.isImmersive ? 'local' : 'viewer';
      session.requestReferenceSpace(refSpaceType).then((refSpace) => {
        if (session.isImmersive) {
          xrImmersiveRefSpace = refSpace;
          xrImmersiveRefSpace.addEventListener('reset', (evt) => {
            if (evt.transform) {
              xrImmersiveRefSpace = xrImmersiveRefSpace.getOffsetReferenceSpace(evt.transform);
            }
          });
        } else {
          inlineViewerHelper = new InlineViewerHelper(gl.canvas, refSpace);
        }
        session.requestAnimationFrame(onXRFrame);
      });
    }

    function onEndSession(session) {
      session.end();
    }

    function onSessionEnded(event) {
      if (event.session.isImmersive) {
        xrButton.setSession(null);
      }
    }

    function onXRFrame(t, frame) {
      let session = frame.session;
      let refSpace = session.isImmersive ? xrImmersiveRefSpace : inlineViewerHelper.referenceSpace;
      let pose = frame.getViewerPose(refSpace);
      scene.startFrame();
      session.requestAnimationFrame(onXRFrame);
      scene.drawXRFrame(frame, pose);
      scene.endFrame();
    }

    initXR();
  </script>
</body>
</html>
