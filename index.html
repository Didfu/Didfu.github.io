<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AR Navigation with Grid Map</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        #hud {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
            z-index: 10;
        }
        #map-container {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: 200px;
            height: 200px;
            border: 2px solid #000;
            padding: 10px;
            border-radius: 5px;
            z-index: 10;
            background-color: white;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #location-dot {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: blue;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>
    <div id="hud">
        <label for="room-select">Select Room:</label>
        <select id="room-select">
            <option value="19.443582,72.799662">303</option>
            <option value="19.449607,72.804369">309</option>
            <option value="18.959680,72.809986">305</option>
        </select>
    </div>

    <div id="map-container">
        <img id="map" src="map.png" alt="Map" />
        <div id="location-dot"></div>
    </div>

    <a-scene embedded arjs="sourceType: webcam;">
        <a-marker preset="hiro">
            <a-box position="0 0.5 0" material="color: blue;"></a-box>
        </a-marker>

        <a-camera id="camera" position="0 0 0" look-controls>
            <a-cone id="arrow" radius-bottom="0.175" height="0.2" color="red" position="0 0 -2"></a-cone>
        </a-camera>
    </a-scene>

    <script>
        const destination = { lat: 19.443582, lng: 72.799662 };
        let gridMatrix = [];

        // Load grid from local file
        async function loadGrid() {
            const response = await fetch('mapgrid.txt');
            const text = await response.text();
            gridMatrix = text.trim().split('\n').map(line => line.split(' ').map(Number));
        }

        const gridWidth = 999;
        const gridHeight = 999;

        const latMin = 18.9570, lngMin = 72.7990;
        const latMax = 19.4500, lngMax = 72.8100;

        function gpsToGrid(lat, lng) {
            const normalizedLat = (lat - latMin) / (latMax - latMin);
            const normalizedLng = (lng - lngMin) / (lngMax - lngMin);
            const gridX = Math.floor(normalizedLng * gridWidth);
            const gridY = Math.floor((1 - normalizedLat) * gridHeight);
            return { gridX, gridY };
        }

        function gridToARPosition(gridX, gridY, gridWidth, gridHeight) {
            const x = (gridX / gridWidth) * 2 - 1;  // Adjust the scale based on your AR space
            const z = (gridY / gridHeight) * 2 - 1; // Adjust the scale based on your AR space
            return { x, y: 0, z };
        }

        function updateArrowDirection(userLat, userLng) {
            const arrow = document.getElementById('arrow');
            const dx = destination.lng - userLng;
            const dy = destination.lat - userLat;
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;

            // Place arrow directly in front of the camera
            arrow.setAttribute('rotation', `0 ${-angle} 0`); // Adjust Y rotation
        }

        function getCurrentPosition() {
            navigator.geolocation.watchPosition(position => {
                const userLat = position.coords.latitude;
                const userLng = position.coords.longitude;

                updateArrowDirection(userLat, userLng);

                const userGridPos = gpsToGrid(userLat, userLng);
                const locationDot = document.getElementById('location-dot');
                const dotPosition = gridToARPosition(userGridPos.gridX, userGridPos.gridY, gridWidth, gridHeight);
                locationDot.style.left = `${dotPosition.x * 100}px`; // Scale for visibility
                locationDot.style.top = `${dotPosition.z * 100}px`;  // Scale for visibility
            });
        }

        loadGrid().then(() => {
            getCurrentPosition();
        });

        document.getElementById('room-select').addEventListener('change', function() {
            const coords = this.value.split(',');
            const lat = parseFloat(coords[0]);
            const lng = parseFloat(coords[1]);
            
            destination.lat = lat;
            destination.lng = lng;
            let roomURL = '';
            switch (this.value) {
                case "19.443582,72.799662":
                    roomURL = 'https://didfu.github.io';
                    break;
                case "19.449607,72.804369":
                    roomURL = 'https://didfu.github.io/309';
                    break;
                case "18.959680,72.809986":
                    roomURL = 'https://didfu.github.io/305';
                    break;
                default:
                    roomURL = 'https://didfu.github.io/';
            }
            window.location.href = roomURL;
        });
    </script>
</body>
</html>
