<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="css/common.css">
  <title>AR Session</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    #ar-view {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
    }
    #start-ar-button {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 5px;
      font-size: 20px;
      cursor: pointer;
      z-index: 2;
    }
  </style>
</head>
<body>
  <div id="ar-view"></div>
  <button id="start-ar-button">Start CAR</button>

  <script type="module">
    import { WebXRButton } from './js/util/webxr-button.js';
    import { Scene } from './js/render/scenes/scene.js';
    import { Renderer, createWebGLContext } from './js/render/core/renderer.js';
    import { InlineViewerHelper } from './js/util/inline-viewer-helper.js';
    import WebXRPolyfill from './js/third-party/webxr-polyfill/build/webxr-polyfill.module.js';
    import { Mesh, PlaneGeometry, MeshBasicMaterial, CanvasTexture, TextureLoader, OrthographicCamera } from 'three';

    let xrButton = null;
    let xrImmersiveRefSpace = null;
    let inlineViewerHelper = null;
    let gl = null;
    let renderer = null;
    let scene = new Scene();
    let arViewCanvas = null;

    // Create a 3D UI Overlay as a HUD
    function createUIOverlay() {
      const textureCanvas = document.createElement('canvas');
      textureCanvas.width = 256;
      textureCanvas.height = 256;
      const context = textureCanvas.getContext('2d');
      
      // Draw a dropdown menu-like UI on the canvas
      context.fillStyle = 'rgba(255, 255, 255, 0.8)';
      context.fillRect(0, 0, 256, 256);
      context.fillStyle = 'black';
      context.font = '20px Arial';
      context.fillText('Select Room:', 10, 30);
      context.fillRect(10, 50, 200, 30);
      context.fillStyle = 'grey';
      context.fillRect(15, 55, 190, 20);

      const texture = new CanvasTexture(textureCanvas);
      const material = new MeshBasicMaterial({ map: texture, transparent: true });
      const geometry = new PlaneGeometry(1, 1);
      const plane = new Mesh(geometry, material);

      plane.position.set(0, 0, -1.5); // Adjust position to be in front of the user
      plane.scale.set(1, 1, 1); // Adjust size to fit the AR view

      scene.addNode(plane);
    }

    function initXR() {
      xrButton = new WebXRButton({
        onRequestSession: onRequestSession,
        onEndSession: onEndSession,
        textEnterXRTitle: "START AR",
        textXRNotFoundTitle: "AR NOT FOUND",
        textExitXRTitle: "EXIT AR",
      });

      document.getElementById('start-ar-button').addEventListener('click', () => {
        document.getElementById('start-ar-button').style.display = 'none';
        navigator.xr.requestSession('immersive-ar').then(onSessionStarted);
      });
    }

    function onRequestSession() {
      return navigator.xr.requestSession('immersive-ar')
        .then((session) => {
          xrButton.setSession(session);
          session.isImmersive = true;
          onSessionStarted(session);
        });
    }

    function initGL() {
      if (gl) return;
      gl = createWebGLContext({ xrCompatible: true });
      document.getElementById('ar-view').appendChild(gl.canvas);
      function onResize() {
        gl.canvas.width = gl.canvas.clientWidth * window.devicePixelRatio;
        gl.canvas.height = gl.canvas.clientHeight * window.devicePixelRatio;
      }
      window.addEventListener('resize', onResize);
      onResize();
      renderer = new Renderer(gl);
      scene.setRenderer(renderer);
    }

    function onSessionStarted(session) {
      session.addEventListener('end', onSessionEnded);
      initGL();
      createUIOverlay(); // Create the HUD overlay in the AR view
      session.updateRenderState({ baseLayer: new XRWebGLLayer(session, gl) });
      let refSpaceType = session.isImmersive ? 'local' : 'viewer';
      session.requestReferenceSpace(refSpaceType).then((refSpace) => {
        if (session.isImmersive) {
          xrImmersiveRefSpace = refSpace;
          xrImmersiveRefSpace.addEventListener('reset', (evt) => {
            if (evt.transform) {
              xrImmersiveRefSpace = xrImmersiveRefSpace.getOffsetReferenceSpace(evt.transform);
            }
          });
        } else {
          inlineViewerHelper = new InlineViewerHelper(gl.canvas, refSpace);
        }
        session.requestAnimationFrame(onXRFrame);
      });
    }

    function onEndSession(session) {
      session.end();
    }

    function onSessionEnded(event) {
      if (event.session.isImmersive) {
        xrButton.setSession(null);
        document.getElementById('start-ar-button').style.display = 'block';
      }
    }

    function onXRFrame(t, frame) {
      let session = frame.session;
      let refSpace = session.isImmersive ? xrImmersiveRefSpace : inlineViewerHelper.referenceSpace;
      let pose = frame.getViewerPose(refSpace);
      scene.startFrame();
      session.requestAnimationFrame(onXRFrame);
      scene.drawXRFrame(frame, pose);
      scene.endFrame();
    }

    window.addEventListener('load', () => {
      initXR();
    });
  </script>
</body>
</html>
