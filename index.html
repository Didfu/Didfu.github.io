<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AR Navigation</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        #hud {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
            z-index: 10; 
        }
    </style>
</head>
<body>
    <div id="hud">
        <label for="room-select">Select Room:</label>
        <select id="room-select">
            <option value="19.2681461, 72.9675232">301</option>
            <option value="18.9586799,72.8097855">chowpatty temple</option>
            <option value="19.2682832, 72.9677273">304c</option>
        </select>
    </div>

    <a-scene embedded arjs='sourceType: webcam;'>
        <a-camera position="0 0 0" look-controls></a-camera>
        <a-cone id="arrow" radius-bottom="0.08" height="0.4" color="red" position="0 0 -2"></a-cone> 

        <a-entity id="grid-map"></a-entity> 

        <a-plane position="0 1.6 -2" width="1.5" height="0.4" color="#FFFFFF" opacity="0.8"></a-plane>
    </a-scene>

    <script>
        let destination = new THREE.Vector3();

        function updateDestination(lat, lng) {
            navigator.geolocation.getCurrentPosition(position => {
                const { latitude, longitude } = position.coords;
                destination = latLngToVector3(lat, lng, latitude, longitude);
            }, showError, {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0 
            });
        }

        function showError(error) {
            console.error('Geolocation error:', error);
            // TODO: Add user-friendly feedback here (e.g., alert or message in the HUD)
        }

        function latLngToVector3(latDest, lngDest, latOrigin, lngOrigin) {
            const earthRadius = 6371; // Earth's radius in kilometers

            const latDiff = THREE.MathUtils.degToRad(latDest - latOrigin);
            const lngDiff = THREE.MathUtils.degToRad(lngDest - lngOrigin);

            const a = Math.sin(latDiff / 2) * Math.sin(latDiff / 2) +
                      Math.cos(THREE.MathUtils.degToRad(latOrigin)) * Math.cos(THREE.MathUtils.degToRad(latDest)) *
                      Math.sin(lngDiff / 2) * Math.sin(lngDiff / 2);

            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const distance = earthRadius * c; 

            const x = distance * Math.cos(lngDiff);
            const y = 0;
            const z = distance * Math.sin(lngDiff);

            return new THREE.Vector3(x, y, z);
        }

        document.getElementById('room-select').addEventListener('change', (event) => {
            const [lat, lng] = event.target.value.split(',').map(Number);
            updateDestination(lat, lng);
        });

        AFRAME.registerComponent('navigation-helper', {
            tick: function () {
                const camera = document.querySelector('[camera]');
                const arrow = document.querySelector('#arrow');

                if (camera && arrow && destination) {
                    const cameraWorldPosition = new THREE.Vector3();
                    camera.object3D.getWorldPosition(cameraWorldPosition);

                    const direction = new THREE.Vector3();
                    direction.subVectors(destination, cameraWorldPosition).normalize();

                    let angle = Math.atan2(direction.x, direction.z);
                    angle = THREE.MathUtils.radToDeg(angle); 

                    arrow.setAttribute('rotation', `0 ${angle} 0`);
                }
            }
        });

        document.querySelector('a-scene').setAttribute('navigation-helper', '');

        // Grid Map Implementation (Example with pre-defined data)
        const gridSize = 4; 
        const cellSize = 0.5; 

        for (let i = -gridSize / 2; i < gridSize / 2; i++) {
            for (let j = -gridSize / 2; j < gridSize / 2; j++) {
                const plane = document.createElement('a-plane');
                plane.setAttribute('width', cellSize);
                plane.setAttribute('height', cellSize);
                plane.setAttribute('color', '#CCCCCC');
                plane.setAttribute('rotation', '-90 0 0');
                plane.setAttribute('position', `${i * cellSize} 0 ${j * cellSize}`);
                document.querySelector('#grid-map').appendChild(plane);
            }
        }

        // Check for AR.js Errors
        window.addEventListener('error', function(event) {
            console.error('Error occurred:', event.error);
            // TODO: Add user-friendly feedback here
        });

        // Add camera permission error handling
        navigator.permissions.query({ name: 'camera' }).then(function(permissionStatus) {
            if (permissionStatus.state !== 'granted') {
                alert('Camera permission is required for this application to work.');
            }
        });
    </script>
</body>
</html>

