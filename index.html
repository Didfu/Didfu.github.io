<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AR Navigation</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
    <a-scene embedded arjs='sourceType: webcam;'>
        <a-camera position="0 0 0" look-controls>
            <!-- HUD Menu -->
            <a-entity id="hud" position="0 -0.5 -2">
                <a-plane color="#FFFFFF" width="1.5" height="0.5" position="0 0 0" opacity="0.8"></a-plane>
                <a-text value="Select Room:" position="-0.6 0.1 0" color="#000000"></a-text>
                <a-entity id="room-select-entity" position="0 0 0">
                    <a-plane color="#FFFFFF" width="1" height="0.2" position="0 -0.1 0" opacity="1">
                        <a-text id="room-select-text" value="Room 1" position="-0.4 0 0" color="#000000"></a-text>
                    </a-plane>
                </a-entity>
            </a-entity>
        </a-camera>
        <!-- Arrow -->
        <a-cone id="arrow" radius-bottom="0.05" height="0.2" color="red" position="0 0 -1" rotation="90 0 0"></a-cone>
    </a-scene>

    <script>
        const rooms = [
            { name: 'Room 1', lat: 18.9576799, lng: 72.8097855 },
            { name: 'Room 2', lat: 18.9586799, lng: 72.8097855 },
            { name: 'Room 3', lat: 18.9596799, lng: 72.8097855 }
        ];

        let destination = new THREE.Vector3();

        function updateDestination(lat, lng) {
            navigator.geolocation.getCurrentPosition(position => {
                const { latitude, longitude } = position.coords;
                destination = latLngToVector3(lat, lng, latitude, longitude);
            }, showError);
        }

        function showError(error) {
            console.error('Geolocation error:', error);
        }

        function latLngToVector3(latDest, lngDest, latOrigin, lngOrigin) {
            const earthRadius = 6371; // Earth's radius in kilometers

            const latDiff = THREE.MathUtils.degToRad(latDest - latOrigin);
            const lngDiff = THREE.MathUtils.degToRad(lngDest - lngOrigin);

            const a = Math.sin(latDiff / 2) * Math.sin(latDiff / 2) +
                      Math.cos(THREE.MathUtils.degToRad(latOrigin)) * Math.cos(THREE.MathUtils.degToRad(latDest)) *
                      Math.sin(lngDiff / 2) * Math.sin(lngDiff / 2);

            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const distance = earthRadius * c; // Distance in kilometers

            const x = distance * Math.cos(lngDiff);
            const y = 0;
            const z = distance * Math.sin(lngDiff);

            return new THREE.Vector3(x, y, z);
        }

        document.querySelector('#room-select-entity').addEventListener('click', () => {
            const currentText = document.querySelector('#room-select-text').getAttribute('value');
            let currentIndex = rooms.findIndex(room => room.name === currentText);
            currentIndex = (currentIndex + 1) % rooms.length;
            const nextRoom = rooms[currentIndex];

            document.querySelector('#room-select-text').setAttribute('value', nextRoom.name);
            updateDestination(nextRoom.lat, nextRoom.lng);
        });

        AFRAME.registerComponent('arrow-behavior', {
            tick: function () {
                const camera = document.querySelector('[camera]');
                const arrow = document.querySelector('#arrow');

                if (camera && arrow && destination) {
                    // Ensure the arrow is always in front of the camera
                    arrow.object3D.position.set(0, -0.5, -1).applyMatrix4(camera.object3D.matrixWorld);

                    // Calculate the direction to the destination
                    const direction = new THREE.Vector3();
                    direction.subVectors(destination, camera.object3D.position).normalize();
                    const arrowDirection = new THREE.Vector3(0, 0, -1);
                    const rotationQuaternion = new THREE.Quaternion().setFromUnitVectors(arrowDirection, direction);

                    arrow.object3D.setRotationFromQuaternion(rotationQuaternion);
                }
            }
        });

        document.querySelector('#arrow').setAttribute('arrow-behavior', '');
    </script>
</body>
</html>
