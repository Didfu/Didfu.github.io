<html>
  <head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=no'>
    <meta name='mobile-web-app-capable' content='yes'>
    <meta name='apple-mobile-web-app-capable' content='yes'>
    <link rel='icon' type='image/png' sizes='32x32' href='favicon-32x32.png'>
    <link rel='icon' type='image/png' sizes='96x96' href='favicon-96x96.png'>
    <link rel='stylesheet' href='css/common.css'>

    <title>Immersive AR Session</title>
  </head>
  <body>
    <header>
      <details open>
        <summary>Immersive AR Session</summary>
        <p>
          This sample demonstrates how to use an 'immersive-ar' XRSession to
          present a simple WebGL scene to a transparent or passthrough XR
          device. 
          <a class="back" href="./">Back</a>
        </p>
      </details>
    </header>
    <script type="module">
      let xrButton = null;
      let xrImmersiveRefSpace = null;
      let gl = null;

      function initXR() {
        xrButton = new WebXRButton({
          onRequestSession: onRequestSession,
          onEndSession: onEndSession,
          textEnterXRTitle: "START AR",
          textXRNotFoundTitle: "AR NOT FOUND",
          textExitXRTitle: "EXIT  AR",
        });
        document.querySelector('header').appendChild(xrButton.domElement);
        if (navigator.xr) {
          navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
            xrButton.enabled = supported;
          });
          navigator.xr.requestSession('inline').then(onSessionStarted);
        }
      }
      
      function onRequestSession() {
        return navigator.xr.requestSession('immersive-ar')
            .then((session) => {
              xrButton.setSession(session);
              session.isImmersive = true;
              onSessionStarted(session);
            });
      }
      
      function initGL() {
        if (gl) return;
        gl = createWebGLContext({
          xrCompatible: true
        });
        document.body.appendChild(gl.canvas);
        function onResize() {
          gl.canvas.width = gl.canvas.clientWidth * window.devicePixelRatio;
          gl.canvas.height = gl.canvas.clientHeight * window.devicePixelRatio;
        }
        window.addEventListener('resize', onResize);
        onResize();
      }

      function onSessionStarted(session) {
        session.addEventListener('end', onSessionEnded);
        initGL();
        session.updateRenderState({ baseLayer: new XRWebGLLayer(session, gl) });
        session.requestReferenceSpace('local').then((refSpace) => {
          xrImmersiveRefSpace = refSpace;
          session.requestAnimationFrame(onXRFrame);
        });
      }

      function onEndSession(session) {
        session.end();
      }

      function onSessionEnded(event) {
        xrButton.setSession(null);
      }

      function onXRFrame(t, frame) {
        let session = frame.session;
        let refSpace = xrImmersiveRefSpace;
        let pose = frame.getViewerPose(refSpace);
        session.requestAnimationFrame(onXRFrame);

        if (pose) {
          const glLayer = session.renderState.baseLayer;
          gl.bindFramebuffer(gl.FRAMEBUFFER, glLayer.framebuffer);
          gl.clearColor(0.5, 0.5, 0.5, 1.0); // Set a grey color
          gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
        }
      }
      
      initXR();

      function createWebGLContext(options) {
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl', options);
        return gl;
      }
      
      class WebXRButton {
        constructor({ onRequestSession, onEndSession, textEnterXRTitle, textXRNotFoundTitle, textExitXRTitle }) {
          this.domElement = document.createElement('button');
          this.domElement.textContent = textEnterXRTitle;
          this.domElement.addEventListener('click', () => {
            this.session ? onEndSession(this.session) : onRequestSession();
          });
          this.setSession = (session) => {
            this.session = session;
            this.domElement.textContent = session ? textExitXRTitle : textEnterXRTitle;
          };
          this.enabled = false;
        }
        set enabled(value) {
          this.domElement.disabled = !value;
          this.domElement.textContent = value ? this.domElement.textContent : 'AR NOT FOUND';
        }
      }
    </script>
  </body>
</html>
